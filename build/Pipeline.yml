name: Rhino.Clients.VsCodeExtension.$(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)

trigger:
  branches:
    include:
    - none

variables:
- group: github.com                # Variable group for GitHub credentials
- group: marketplace.visualstudio  # Variable group for Visual Studio Marketplace credentials

pool:
  vmImage: ubuntu-latest

stages:
  - stage: BuildAndPublish
    jobs:
    - job: BuildAndPublishJob 
      displayName: 'Build and Publish VSCode Extension'
      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'
        displayName: 'Install Node.js'

      - script: |
          cd src/
          npm install
          npm run esbuild
        displayName: 'Install Dependencies and Build'

      - script: |
          npm install --global @vscode/vsce
        displayName: 'Install `vsce` CLI'

      - script: |
          cd src/
          vsce package
        displayName: 'Package VSCode Extension'

      - script: |
          cd src/
          vsce publish -p $(Marketplace.Pat)
        displayName: 'Publish VSCode Extension'
